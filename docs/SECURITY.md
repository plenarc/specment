# セキュリティガイド

このドキュメントでは、NPM公開ワークフローのセキュリティ設定と最適化について説明します。

## セキュリティ設定概要

### 1. 権限設定（最小権限の原則）

GitHub Actionsワークフローでは、以下の最小限の権限のみを付与しています：

```yaml
permissions:
  contents: write    # リポジトリへの書き込み（タグ作成、リリース作成用）
  id-token: write    # OIDC トークン発行（npm provenance用）
  actions: read      # アクション実行状況の読み取り
  checks: read       # チェック結果の読み取り
```

### 2. シークレット管理

#### NPM_TOKEN
- **用途**: npm公開用の認証トークン
- **権限**: `publish`スコープが必須
- **推奨事項**: 
  - 定期的な更新（3-6ヶ月ごと）
  - Automation用トークンの使用
  - トークン形式: `npm_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

#### GITHUB_TOKEN
- **用途**: GitHub API操作用（タグ作成、リリース作成）
- **権限**: `contents: write`が必要
- **自動提供**: GitHub Actionsにより自動的に提供

### 3. 機密情報の保護

#### ログ出力での保護
```bash
# 機密情報の隠蔽
echo "  ✓ Auth token: [CONFIGURED - VALUE HIDDEN FOR SECURITY]"

# デバッグ出力の抑制
export NPM_TOKEN="${{ secrets.NPM_TOKEN }}" 2>/dev/null
sed -i "s/\${NPM_TOKEN}/$NPM_TOKEN/g" ~/.npmrc 2>/dev/null
```

#### ファイル権限の制限
```bash
# .npmrcファイルの権限を制限
chmod 600 ~/.npmrc
```

### 4. サプライチェーンセキュリティ

#### npm provenance
```bash
# npm公開時にprovenanceを有効化
NPM_CONFIG_PROVENANCE=true pnpm changeset publish --verbose
```

これにより、パッケージの出所と整合性を検証可能になります。

### 5. 実行環境のセキュリティ

#### 推奨設定
- **実行環境**: `windows-latest`（WSL使用）
- **シェル**: `wsl-bash {0}`（明示的指定）
- **同時実行制御**: 有効化

## セキュリティ検証

### 自動検証スクリプト

プロジェクトには自動セキュリティ検証スクリプトが含まれています：

```bash
node scripts/security-check.js
```

このスクリプトは以下を検証します：
- 権限設定の適切性
- シークレットの正しい使用
- 機密情報の保護
- セキュリティベストプラクティスの適用

### 検証項目

✅ **合格項目**:
- contents権限（write）の設定
- id-token権限（write）の設定
- actions権限（read）の設定
- checks権限（read）の設定
- NPM_TOKENの適切な参照
- GITHUB_TOKENの適切な参照
- 環境変数の正しい設定
- セキュリティコメントの存在
- 機密情報の隠蔽実装
- デバッグ出力の抑制
- npm provenanceの有効化
- 実行環境の適切な指定
- 同時実行制御の設定
- シェル設定の明示的指定

## セキュリティベストプラクティス

### 1. トークン管理
- NPM_TOKENは定期的に更新する
- トークンの権限は最小限に制限する
- 使用しなくなったトークンは即座に削除する

### 2. ログ監査
- ワークフローの実行ログを定期的に確認する
- 機密情報の漏洩がないかチェックする
- 異常なアクセスパターンを監視する

### 3. 権限管理
- 最小権限の原則を厳守する
- 不要な権限は付与しない
- 権限の変更は慎重に検討する

### 4. 依存関係のセキュリティ
- 依存関係の脆弱性を定期的にスキャンする
- セキュリティアップデートを迅速に適用する
- 信頼できるパッケージのみを使用する

## インシデント対応

### トークン漏洩時の対応
1. **即座の対応**
   - 漏洩したトークンを無効化
   - 新しいトークンを生成
   - GitHub Secretsを更新

2. **影響調査**
   - 漏洩期間の特定
   - 不正使用の有無を確認
   - 影響範囲の評価

3. **再発防止**
   - セキュリティ設定の見直し
   - 監査ログの強化
   - チーム教育の実施

## 連絡先

セキュリティに関する問題や質問がある場合は、以下にお問い合わせください：

- **セキュリティ問題**: [セキュリティ担当者のメール]
- **技術的質問**: [開発チームのメール]
- **緊急事態**: [緊急連絡先]

## 更新履歴

- 2025-01-17: 初版作成
- セキュリティ設定の最適化完了
- 自動検証スクリプトの追加